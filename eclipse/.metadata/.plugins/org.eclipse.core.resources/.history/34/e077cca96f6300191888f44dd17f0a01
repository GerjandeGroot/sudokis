#include "Main.h"

alt_up_parallel_port_dev* greenLeds = alt_up_parallel_port_open_dev("/dev/Green_LEDs");
alt_up_parallel_port_dev* redLeds = alt_up_parallel_port_open_dev("/dev/Red_LEDs");
alt_up_parallel_port_dev* keys = alt_up_parallel_port_open_dev("/dev/Pushbuttons");
alt_up_parallel_port_dev* expansion = alt_up_parallel_port_open_dev("/dev/Expansion_JP5");
alt_up_pixel_buffer_dma_dev* pb = alt_up_pixel_buffer_dma_open_dev("/dev/VGA_Subsystem_VGA_Pixel_DMA");
alt_up_pixel_buffer_dma_dev* av = alt_up_pixel_buffer_dma_open_dev("/dev/Video_In_Subsystem_Video_In_DMA");
alt_up_video_dma_dev* dma = alt_up_video_dma_open_dev("/dev/VGA_Subsystem_Char_Buf_Subsystem_Char_Buf_DMA");
//alt_up_av_config_dev* av = alt_up_av_config_open_dev("");

void startTimer() {
	IOWR(timerBase,2,0xFFFF);
	IOWR(timerBase,3,0xFFFF);
	IOWR(timerBase,1,0b110);
	int n = IORD(timerBase,0);
	while (n) {
	    if (n & 1)
	        printf("1");
	    else
	        printf("0");

	    n >>= 1;
	}
	printf("\n");
}

void drawPixel(int x,int y,bool on) {
	int color;
	if(on) {
		color = 0xFFFFFF;
	} else {
		color = 0;
	}
	alt_up_pixel_buffer_dma_draw(pb,color,x,y);
}

void drawPixelRaw(int x,int y,uint16_t value) {
	alt_up_pixel_buffer_dma_draw(pb,value,x,y);
}

void drawPixelRaw(int x,int y,uint8_t r, uint8_t g, uint8_t b) {
	uint16_t color = 0;
	color |= (r & 0b11111) << 11;
	color |= (g & 0b111111) << 5;
	color |= (b & 0b11111);
	alt_up_pixel_buffer_dma_draw(pb,color,x,y);
}

uint16_t readPixel(uint16_t x, uint16_t y) {
	uint32_t addr=0;
	addr += ((x & pb->x_coord_mask) << pb->x_coord_offset);
	addr += ((y & pb->y_coord_mask) << pb->y_coord_offset);
	return IORD_16DIRECT(pb->back_buffer_start_address, addr);
}

void init() {
	printf("greenLeds: %d\n", greenLeds);
	printf("expansion: %d\n", expansion);
	printf("redLeds: %d\n", redLeds);
	printf("av: %x\n", av);
	printf("keys: %x\n", keys);
	alt_up_parallel_port_set_port_direction(expansion, 0xFFFFFF);
	usleep(100000000);
	startTimer();

	stepper stepper1 = stepper(1, 0, 1);
	stepper1.setMaxSpeed(4000);
	stepper1.setAcceleration(1000);
	stepper1.setMinPulseWidth(1);

	//displayImage();
	printf("adress: %x\n", av->buffer_start_address);
	//alt_up_pixel_buffer_dma_change_back_buffer_address(pb,av->buffer_start_address);
	//if(!alt_up_pixel_buffer_dma_check_swap_buffers_status(pb)) alt_up_pixel_buffer_dma_swap_buffers(pb);

	IOWR(0x10003060,3,0b100);

	while(1) {
		if(alt_up_parallel_port_read_data(keys) & 0b10) {
			IOWR(0x10003060,3,0b000);
			break;
		}
	}

	OCR ocr;
	ocr.draw(0,0);
	usleep(10000000);

	Image image = Image(320,240);
	image.loadImage();
	image.draw(0,0);

	while (1) {
		alt_up_pixel_buffer_dma_clear_screen(pb, 0);
		//image.draw(0,0);
		Image newImage = image.extract();
		newImage.draw(0,0);
		for (int x = 0; x < newImage.width; ++x) {
			for (int y = 0; y < newImage.height; ++y) {
		//		drawPixelRaw(x,y,255,0,0);
			}
		}
		usleep(1000000);
	}

	while(1) {
		printf("%d\n",micros());
		alt_up_parallel_port_write_data(redLeds, micros());
		stepper1.runToNewPosition(5000);
		stepper1.runToNewPosition(0);
		//usleep(1000000);
	}
}

int constrain(int x, int a, int b) {
	if(x<a)x=a;
	if(x>b)x=b;
	return x;
}

void pinMode(uint8_t pin, uint8_t mode) {
	if(mode == INPUT) {
		alt_up_parallel_port_write_data(expansion, alt_up_parallel_port_read_data(expansion) & ~(1 << pin));
	} else if (mode == OUTPUT) {
		alt_up_parallel_port_write_data(expansion, alt_up_parallel_port_read_data(expansion) | (1 << pin));
	}
}

void digitalWrite(uint8_t pin, boolean on) {
	if(on) {
		alt_up_parallel_port_write_data(expansion, alt_up_parallel_port_read_data(expansion) | (1 << pin));
	} else {
		alt_up_parallel_port_write_data(expansion, alt_up_parallel_port_read_data(expansion) & ~(1 << pin));
	}
}

unsigned long micros() {
	IOWR(timerBase, 4,1);
	return 0xFFFFFFFF -(((IORD(timerBase,5) << 16) | IORD(timerBase,4)) / 50);
}

void schermSpul() {
	alt_up_pixel_buffer_dma_dev* pb = alt_up_pixel_buffer_dma_open_dev("/dev/VGA_Subsystem_VGA_Pixel_DMA");
	printf("pb: %d\n",pb);

	alt_up_video_dma_dev* dma = alt_up_video_dma_open_dev("/dev/VGA_Subsystem_Char_Buf_Subsystem_Char_Buf_DMA");
	printf("dma: %d\n",dma);

	alt_up_pixel_buffer_dma_clear_screen(pb, 0);

	int i = 0;
	while(1) {
		alt_up_pixel_buffer_dma_draw_rectangle(pb, 100, 100, 200, 200, i, 0);
		i++;
	}
}

void clearScreen() {
	alt_up_pixel_buffer_dma_clear_screen(pb, 0);
	alt_up_video_dma_screen_clear(dma, 0);
}



